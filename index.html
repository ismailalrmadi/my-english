<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الخطة السنوية لتعلم الإنجليزية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals & Soft Teal -->
    <!-- Application Structure Plan: The SPA is designed with a top-down information architecture. Key navigation is a horizontal scrollable bar of months, allowing quick access to any part of the year. Below this, a prominent "الدرس المحدد" (Selected Lesson) area provides a focused view of a single day's content. The main body consists of a grid of "cards," each representing a day within the selected month. This structure was chosen for usability because it prevents overwhelming the user with 365 items at once. It provides a clear monthly overview (the cards) and a detailed, uncluttered daily focus (the main display), which is ideal for a daily learning plan. -->
    <!-- Visualization & Content Choices: The source report is entirely textual and structured chronologically. Goal: Organize & Inform. Presentation Method: The primary method is dynamically generated HTML content blocks (cards and a main display area). This is superior to a static table for interactivity and mobile usability. Interaction: Users filter the entire dataset by clicking a month, then select a specific day's card to view its details. This interaction directly supports the designed structure. Justification: This approach makes navigating a year-long plan intuitive and fast. Since there is no quantitative data suitable for charts, Chart.js/Plotly were not used. All content is presented as structured, interactive text. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #FDFCFB;
        }
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        .month-nav::-webkit-scrollbar {
            display: none;
        }
        .month-nav {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14B8A6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .gemini-btn:disabled, .listen-sentence-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold text-teal-700">الخطة السنوية لتعلم الإنجليزية</h1>
            <p class="mt-2 text-lg text-stone-600">منهجكم التفاعلي المدعوم بالذكاء الاصطناعي ✨</p>
        </header>

        <main>
            <!-- Navigation by Month -->
            <nav id="month-navigation" class="month-nav sticky top-0 bg-stone-50/80 backdrop-blur-sm py-4 z-10 mb-8 overflow-x-auto whitespace-nowrap">
                <div id="month-buttons-container" class="flex items-center space-x-4 space-x-reverse px-2">
                    <!-- Month buttons will be dynamically inserted here -->
                </div>
            </nav>

            <!-- Selected Lesson Display -->
            <section id="selected-lesson-section" class="mb-10 p-6 bg-white rounded-2xl shadow-lg border border-stone-200 smooth-scroll">
                 <div class="text-center pb-4 border-b border-stone-200 mb-4">
                     <h2 id="selected-lesson-title" class="text-2xl font-bold text-teal-800">اختر يوماً من الأسفل لتبدأ</h2>
                     <p id="selected-lesson-subtitle" class="text-stone-500"></p>
                 </div>
                 <div id="selected-lesson-content" class="text-center text-lg">
                    <p class="text-stone-500">محتوى الدرس سيظهر هنا.</p>
                 </div>
                 <!-- Gemini Features Section -->
                 <div id="gemini-features" class="mt-6 pt-6 border-t border-stone-200 hidden">
                    <h3 class="text-xl font-bold text-center mb-4 text-teal-700">طور ممارستك مع Gemini ✨</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button id="expand-dialogue-btn" class="gemini-btn bg-teal-600 text-white font-bold py-3 px-4 rounded-full hover:bg-teal-700 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>وسّع الحوار</span>
                        </button>
                        <button id="new-situation-btn" class="gemini-btn bg-teal-100 text-teal-800 font-bold py-3 px-4 rounded-full hover:bg-teal-200 transition-colors duration-300 flex items-center justify-center gap-2">
                            <span>اقترح موقفاً جديداً</span>
                        </button>
                         <button id="visualize-situation-btn" class="gemini-btn bg-indigo-500 text-white font-bold py-3 px-4 rounded-full hover:bg-indigo-600 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>تخيل الموقف 🖼️</span>
                        </button>
                        <button id="explain-rule-btn" class="gemini-btn bg-amber-500 text-white font-bold py-3 px-4 rounded-full hover:bg-amber-600 transition-colors duration-300 flex items-center justify-center gap-2">
                            <span>شرح القاعدة 🧑‍🏫</span>
                        </button>
                         <button id="role-play-btn" class="gemini-btn bg-rose-500 text-white font-bold py-3 px-4 rounded-full hover:bg-rose-600 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>تدرب على الحوار 🎭</span>
                        </button>
                         <button id="quiz-btn" class="gemini-btn bg-lime-500 text-white font-bold py-3 px-4 rounded-full hover:bg-lime-600 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>اختبر مفرداتك 🧠</span>
                        </button>
                        <button id="story-btn" class="gemini-btn bg-cyan-500 text-white font-bold py-3 px-4 rounded-full hover:bg-cyan-600 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>اكتب قصة قصيرة 📖</span>
                        </button>
                        <button id="culture-btn" class="gemini-btn bg-purple-500 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-600 transition-colors duration-300 flex items-center justify-center gap-2 shadow-md">
                            <span>معلومة ثقافية 💡</span>
                        </button>
                    </div>

                    <div id="sentence-correction-feature" class="mt-6 pt-4 border-t border-dashed">
                        <h4 class="font-semibold text-lg text-center text-stone-700 mb-3">تدرب على الكتابة</h4>
                        <div class="flex flex-col gap-3">
                            <textarea id="sentence-input" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-amber-400 transition" placeholder="اكتب جملة هنا باستخدام كلمات اليوم..."></textarea>
                            <button id="correct-sentence-btn" class="gemini-btn bg-orange-500 text-white font-bold py-3 px-6 rounded-full hover:bg-orange-600 transition-colors duration-300 flex items-center justify-center gap-2 self-center">
                                <span>صحح جملتي ✍️</span>
                            </button>
                        </div>
                    </div>

                    <div id="gemini-response-container" class="mt-6 p-4 bg-teal-50/50 rounded-lg min-h-[120px] text-center flex items-center justify-center">
                        <p class="text-stone-500">ستظهر نتائج الذكاء الاصطناعي هنا.</p>
                    </div>
                </div>
            </section>
            
            <!-- Daily Lesson Cards -->
            <section>
                <h2 id="current-month-title" class="text-2xl font-bold mb-6 text-center md:text-right"></h2>
                <div id="daily-cards-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                    <!-- Daily lesson cards will be dynamically inserted here -->
                </div>
            </section>

        </main>

        <footer class="text-center mt-12 py-4 border-t border-stone-200">
            <p class="text-stone-500">تم التصميم والتطوير لتسهيل رحلة تعلم اللغة لأسرتكم.</p>
        </footer>
    </div>
    <audio id="audio-player" class="hidden"></audio>

    <script>
        const yearlyPlanData = [
            { "month": "الشهر الأول: الروتين اليومي", "day": "1", "situation": "الاستيقاظ", "english": "A: Good morning! Time to wake up. B: Good morning. Did you sleep well?", "arabic": "أ: صباح الخير! حان وقت الاستيقاظ. ب: صباح الخير. هل نمت جيدًا؟", "words": "morning, wake up, sleep" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "2", "situation": "الإفطار", "english": "A: What would you like for breakfast? B: I'd like some eggs, please.", "arabic": "أ: ماذا تريد على وجبة الإفطار؟ ب: أريد بعض البيض، من فضلك.", "words": "breakfast, like, eggs" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "3", "situation": "الخروج من المنزل", "english": "A: Have a nice day! Goodbye! B: You too! See you later.", "arabic": "أ: أتمنى لك يومًا لطيفًا! مع السلامة! ب: وأنت أيضًا! أراك لاحقًا.", "words": "day, goodbye, later" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "4", "situation": "العودة للمنزل", "english": "A: Welcome home! How was your day? B: It was good, thank you. A bit busy.", "arabic": "أ: أهلاً بعودتك! كيف كان يومك؟ ب: كان جيدًا، شكرًا لك. حافلاً بعض الشيء.", "words": "home, day, busy" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "5", "situation": "الواجبات", "english": "A: Do you have a lot of homework? B: Yes, I need a little help with Math.", "arabic": "أ: هل لديك الكثير من الواجبات؟ ب: نعم، أحتاج القليل من المساعدة في الرياضيات.", "words": "homework, help, math" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "6", "situation": "العشاء", "english": "A: Dinner is ready. Please come to the table. B: It smells delicious! What did you make?", "arabic": "أ: العشاء جاهز. من فضلكم تعالوا إلى الطاولة. ب: رائحته شهية! ماذا أعددت؟", "words": "dinner, ready, delicious" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "7", "situation": "الاستعداد للنوم", "english": "A: It's time to brush your teeth and go to bed. B: Okay. Can you read me a story?", "arabic": "أ: حان وقت تنظيف أسنانك والذهاب إلى السرير. ب: حسنًا. هل يمكنك أن تقرأ لي قصة؟", "words": "brush teeth, bed, story" },
            { "month": "الشهر الأول: الروتين اليومي", "day": "28", "situation": "مراجعة الشهر", "english": "A: We learned so many new phrases this month! B: Yes! Our English is getting better.", "arabic": "أ: لقد تعلمنا الكثير من العبارات الجديدة هذا الشهر! ب: نعم! لغتنا الإنجليزية تتحسن.", "words": "learned, phrases, better" },
            { "month": "الشهر الثاني: البيت والمهام", "day": "29", "situation": "ترتيب الغرفة", "english": "A: Let's tidy up your room. It's a bit messy. B: Okay. Where should I put my toys?", "arabic": "أ: لنرتب غرفتك. إنها فوضوية قليلاً. ب: حسنًا. أين يجب أن أضع ألعابي؟", "words": "tidy up, room, toys" },
            { "month": "الشهر الثاني: البيت والمهام", "day": "55", "situation": "مراجعة الشهر", "english": "A: Our house looks so clean and tidy. Great teamwork! B: Yes! We are a great team.", "arabic": "أ: منزلنا يبدو نظيفًا ومرتبًا. عمل جماعي رائع! ب: نعم! نحن فريق رائع.", "words": "house, teamwork, great" },
            { "month": "الشهر الثالث: العائلة والأصدقاء", "day": "56", "situation": "استقبال الضيوف", "english": "A: Welcome to our home! Please, come in. B: Thank you for having us. Your home is lovely.", "arabic": "أ: أهلاً بك في منزلنا! تفضل بالدخول. ب: شكرًا لاستضافتنا. منزلك جميل.", "words": "welcome, home, guests" },
            { "month": "الشهر الثالث: العائلة والأصدقاء", "day": "70", "situation": "مراجعة الشهر", "english": "A: It's always nice to spend time with family. B: Yes, family is very important.", "arabic": "أ: من اللطيف دائمًا قضاء الوقت مع العائلة. ب: نعم، العائلة مهمة جدًا.", "words": "spend time, family, important" },
            { "month": "الشهر الرابع: التسوق والمطاعم", "day": "71", "situation": "في السوبر ماركت", "english": "A: We need to buy some groceries. Do we have the list? B: Yes, it's right here. First, we need milk.", "arabic": "أ: نحتاج لشراء بعض البقالة. هل لدينا القائمة؟ ب: نعم، هي هنا. أولاً، نحتاج حليبًا.", "words": "groceries, list, milk" },
            { "month": "الشهر الرابع: التسوق والمطاعم", "day": "84", "situation": "مراجعة الشهر", "english": "A: We went to many places this month. B: Yes, shopping in English is fun.", "arabic": "أ: لقد ذهبنا إلى أماكن كثيرة هذا الشهر. ب: نعم، التسوق باللغة الإنجليزية ممتع.", "words": "places, shopping, fun" },
            { "month": "الشهر الخامس: المشاعر والوصف", "day": "85", "situation": "التعبير عن السعادة", "english": "A: I'm so happy today! I got a good grade. B: That's wonderful news! I'm proud of you.", "arabic": "أ: أنا سعيد جدًا اليوم! حصلت على درجة جيدة. ب: هذه أخبار رائعة! أنا فخور بك.", "words": "happy, good grade, proud" },
            { "month": "الشهر الخامس: المشاعر والوصف", "day": "98", "situation": "مراجعة الشهر", "english": "A: How are you feeling right now? B: I'm feeling great and happy!", "arabic": "أ: كيف تشعر الآن؟ ب: أشعر أنني بحال رائعة وسعيد!", "words": "feeling, great, happy" },
            { "month": "الشهر السادس: خارج المنزل", "day": "99", "situation": "في الحديقة", "english": "A: Let's go to the park and play on the swings. B: Yay! Can we go on the slide too?", "arabic": "أ: هيا نذهب إلى الحديقة ونلعب على الأراجيح. ب: ياي! هل يمكننا الذهاب إلى الزحليقة أيضًا؟", "words": "park, swings, slide" },
            { "month": "الشهر السادس: خارج المنزل", "day": "112", "situation": "مراجعة الشهر", "english": "A: What was your favorite activity this month? B: I loved building the sandcastle at the beach.", "arabic": "أ: ما هو نشاطك المفضل هذا الشهر؟ ب: أحببت بناء القلعة الرملية على الشاطئ.", "words": "favorite, activity, beach" },
            { "month": "الشهر السابع: المدرسة والعمل", "day": "113", "situation": "في الفصل", "english": "A: Please open your books to page ten. B: Yes, teacher.", "arabic": "أ: من فضلكم افتحوا كتبكم على صفحة عشرة. ب: نعم يا معلم.", "words": "open, books, page" },
            { "month": "الشهر السابع: المدرسة والعمل", "day": "126", "situation": "مراجعة الشهر", "english": "A: School and work are important parts of our lives. B: Yes, we learn and grow every day.", "arabic": "أ: المدرسة والعمل أجزاء مهمة من حياتنا. ب: نعم، نحن نتعلم وننمو كل يوم.", "words": "important, learn, grow" },
            { "month": "الشهر الثامن: الهوايات والتكنولوجيا", "day": "213", "situation": "الرسم", "english": "A: What are you drawing? B: I'm drawing a picture of our family.", "arabic": "أ: ماذا ترسم؟ ب: أنا أرسم صورة لعائلتنا.", "words": "drawing, picture, family" },
            { "month": "الشهر الثامن: الهوايات والتكنولوجيا", "day": "226", "situation": "مراجعة الشهر", "english": "A: Hobbies make our lives more interesting. B: I agree! And technology is very useful.", "arabic": "أ: الهوايات تجعل حياتنا أكثر إثارة للاهتمام. ب: أوافق! والتكنولوجيا مفيدة جدًا.", "words": "hobbies, interesting, technology" },
            { "month": "الشهر التاسع: القصص والذكريات", "day": "245", "situation": "الحديث عن الأمس", "english": "A: What did you do yesterday? B: I went to the library and read a book.", "arabic": "أ: ماذا فعلت أمس؟ ب: ذهبت إلى المكتبة وقرأت كتابًا.", "words": "yesterday, went, read" },
            { "month": "الشهر التاسع: القصص والذكريات", "day": "258", "situation": "مراجعة الشهر", "english": "A: It's fun to talk about our memories. B: Yes, we had many good times.", "arabic": "أ: من الممتع التحدث عن ذكرياتنا. ب: نعم، لقد قضينا أوقاتًا جيدة كثيرة.", "words": "memories, had, good times" },
            { "month": "الشهر العاشر: الخطط المستقبلية", "day": "277", "situation": "خطط الغد", "english": "A: What are we going to do tomorrow? B: We are going to visit Grandma.", "arabic": "أ: ماذا سنفعل غدًا؟ ب: سنزور الجدة.", "words": "going to, tomorrow, visit" },
            { "month": "الشهر العاشر: الخطط المستقبلية", "day": "290", "situation": "مراجعة الشهر", "english": "A: It's exciting to think about the future. B: Yes, we have a lot to look forward to.", "arabic": "أ: من المثير التفكير في المستقبل. ب: نعم، لدينا الكثير لنتطلع إليه.", "words": "exciting, future, look forward to" },
            { "month": "الشهر الحادي عشر: مراجعة ودمج المواقف", "day": "305", "situation": "الدمج: تسوق وعشاء", "english": "A: Let's go to the supermarket. We need ingredients for tonight's dinner. B: Good idea. What are you going to make?", "arabic": "أ: هيا نذهب إلى السوبر ماركت. نحتاج مكونات لعشاء الليلة. ب: فكرة جيدة. ماذا ستحضر؟", "words": "supermarket, ingredients, make" },
            { "month": "الشهر الثاني عشر: المشروع النهائي", "day": "331", "situation": "التخطيط للأسبوع الإنجليزي", "english": "A: This week, let's try to speak only English. B: Okay, it will be a fun challenge.", "arabic": "أ: هذا الأسبوع، لنجرب التحدث باللغة الإنجليزية فقط. ب: حسنًا، سيكون تحديًا ممتعًا.", "words": "week, speak, challenge" },
            { "month": "الشهر الثاني عشر: المشروع النهائي", "day": "365", "situation": "الاحتفال بالإنجاز السنوي", "english": "A: We did it! We completed a whole year of learning English together. B: I'm so proud of our family. Our English is so much better now!", "arabic": "أ: لقد فعلناها! أكملنا سنة كاملة من تعلم اللغة الإنجليزية معًا. ب: أنا فخور جدًا بعائلتنا. لغتنا الإنجليزية أفضل بكثير الآن!", "words": "proud, family, better" }
        ];
        
        const state = {
            selectedMonth: null,
            selectedDay: null,
            isTTSLoading: false,
            isGeminiLoading: false,
        };

        const monthButtonsContainer = document.getElementById('month-buttons-container');
        const dailyCardsContainer = document.getElementById('daily-cards-container');
        const selectedLessonTitle = document.getElementById('selected-lesson-title');
        const selectedLessonSubtitle = document.getElementById('selected-lesson-subtitle');
        const selectedLessonContent = document.getElementById('selected-lesson-content');
        const currentMonthTitle = document.getElementById('current-month-title');
        const selectedLessonSection = document.getElementById('selected-lesson-section');
        const geminiFeatures = document.getElementById('gemini-features');
        const geminiResponseContainer = document.getElementById('gemini-response-container');
        const expandDialogueBtn = document.getElementById('expand-dialogue-btn');
        const newSituationBtn = document.getElementById('new-situation-btn');
        const explainRuleBtn = document.getElementById('explain-rule-btn');
        const visualizeSituationBtn = document.getElementById('visualize-situation-btn');
        const correctSentenceBtn = document.getElementById('correct-sentence-btn');
        const sentenceInput = document.getElementById('sentence-input');
        const audioPlayer = document.getElementById('audio-player');
        const rolePlayBtn = document.getElementById('role-play-btn');
        const quizBtn = document.getElementById('quiz-btn');
        const storyBtn = document.getElementById('story-btn');
        const cultureBtn = document.getElementById('culture-btn');


        function setGeminiLoading(isLoading) {
            state.isGeminiLoading = isLoading;
            document.querySelectorAll('.gemini-btn').forEach(btn => {
                btn.disabled = isLoading;
            });
             document.querySelectorAll('.listen-sentence-btn').forEach(btn => {
                btn.disabled = isLoading;
            });
            if (isLoading) {
                geminiResponseContainer.innerHTML = '<div class="loader mx-auto"></div>';
            }
        }

        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const apiKey = "AIzaSyBSDEdkDwi2ltENGOGYyPUtA-hFjQw7Gnk"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status >= 500 && retries > 0) {
                         await new Promise(res => setTimeout(res, delay));
                         return callGeminiAPI(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    return "لم يتمكن الذكاء الاصطناعي من إنشاء رد. حاول مرة أخرى.";
                }
            } catch (error) {
                 if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                return "حدث خطأ أثناء الاتصال بالذكاء الاصطناعي.";
            }
        }

        async function callImagenAPI(prompt, retries = 3, delay = 1000) {
            const apiKey = "AIzaSyBSDEdkDwi2ltENGOGYyPUtA-hFjQw7Gnk"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status >= 500 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callImagenAPI(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`Imagen API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    return null;
                }
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callImagenAPI(prompt, retries - 1, delay * 2);
                }
                return null;
            }
        }
        
        async function callGeminiTTSAPI(textToSpeak, onFinishCallback) {
            const apiKey = "AIzaSyBSDEdkDwi2ltENGOGYyPUtA-hFjQw7Gnk"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: { responseModalities: ["AUDIO"] },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`TTS API call failed: ${response.status}`);
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 24000); 
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    audioPlayer.onended = () => {
                       if (onFinishCallback) onFinishCallback();
                    };
                } else {
                    throw new Error("No audio data in response.");
                }
            } catch (error) {
                 if (onFinishCallback) onFinishCallback();
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function renderMonthButtons(months) {
            monthButtonsContainer.innerHTML = '';
            months.forEach(month => {
                const button = document.createElement('button');
                button.textContent = month.split(':')[0].replace('الشهر ', '');
                button.dataset.month = month;
                button.className = 'month-btn flex-shrink-0 px-4 py-2 text-lg font-semibold text-stone-600 rounded-full transition-colors duration-300 hover:bg-teal-100 hover:text-teal-800';
                button.addEventListener('click', () => {
                    state.selectedMonth = month;
                    renderDailyCards(month);
                    updateActiveMonthButton();
                    selectedLessonContent.innerHTML = `<p class="text-stone-500">اختر يوماً من الأسفل لعرض التفاصيل.</p>`;
                    selectedLessonTitle.textContent = 'اختر يوماً من الأسفل لتبدأ';
                    selectedLessonSubtitle.textContent = '';
                    geminiFeatures.classList.add('hidden');
                });
                monthButtonsContainer.appendChild(button);
            });
        }

        function renderDailyCards(month) {
            dailyCardsContainer.innerHTML = '';
            currentMonthTitle.textContent = month;
            const lessonsForMonth = yearlyPlanData.filter(lesson => lesson.month === month);

            lessonsForMonth.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'day-card bg-white p-4 rounded-xl shadow-md border border-stone-100 cursor-pointer transition-all duration-300 hover:shadow-lg hover:border-teal-300 hover:-translate-y-1';
                card.dataset.day = lesson.day;

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-bold text-teal-600">اليوم ${lesson.day}</span>
                        <span class="text-sm bg-teal-50 text-teal-700 px-2 py-1 rounded-full">${lesson.situation}</span>
                    </div>
                    <p class="text-stone-700 truncate">${lesson.english.split('B:')[0]}</p>
                `;

                card.addEventListener('click', () => {
                    state.selectedDay = lesson;
                    renderSelectedLesson();
                    updateActiveDayCard();
                    selectedLessonSection.scrollIntoView({ behavior: 'smooth' });
                });
                dailyCardsContainer.appendChild(card);
            });
        }
        
        function renderSelectedLesson() {
            if (!state.selectedDay) return;
            
            const lesson = state.selectedDay;
            selectedLessonTitle.textContent = `اليوم ${lesson.day}: ${lesson.situation}`;
            selectedLessonSubtitle.textContent = lesson.month;
            
             const englishLinesHTML = lesson.english.split(/(?=A:|B:)/g).map(line => {
                if (line.trim()) {
                    const cleanLine = line.trim();
                    return `
                        <div class="flex items-center gap-3 text-left dir-ltr">
                            <button class="listen-sentence-btn flex-shrink-0 text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${cleanLine.replace(/"/g, '&quot;')}">
                                <span>🔊</span>
                            </button>
                            <p class="text-lg text-stone-800">${cleanLine.replace(/A:/, '<strong>A:</strong>').replace(/B:/, '<strong>B:</strong>')}</p>
                        </div>
                    `;
                }
                return '';
            }).join('');

            selectedLessonContent.innerHTML = `
                <div class="space-y-4 md:px-4">
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-stone-700">الحوار بالإنجليزية</h3>
                         <div class="bg-stone-100 p-4 rounded-lg space-y-2">
                            ${englishLinesHTML}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-stone-700">الحوار بالعربية</h3>
                        <p class="text-lg bg-stone-100 p-4 rounded-lg text-stone-800">${lesson.arabic.replace(/أ:/g, '<strong>أ:</strong>').replace(/ب:/g, '<br><strong>ب:</strong>')}</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-stone-700">كلمات اليوم الأساسية</h3>
                        <div class="flex flex-wrap justify-center gap-2">
                            ${lesson.words.split(',').map(word => `<span class="bg-teal-100 text-teal-800 text-base font-medium px-3 py-1 rounded-full">${word.trim()}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            geminiFeatures.classList.remove('hidden');
            geminiResponseContainer.innerHTML = `<p class="text-stone-500">جرّب إحدى الميزات أعلاه!</p>`;
        }
        
        async function handleGeminiButtonClick(apiCallFunction) {
            if (!state.selectedDay || state.isGeminiLoading) return;
            setGeminiLoading(true);
            try {
                await apiCallFunction();
            } catch (e) {
                geminiResponseContainer.innerHTML = `<p class="text-red-500">حدث خطأ غير متوقع.</p>`;
            } finally {
                setGeminiLoading(false);
            }
        }

        expandDialogueBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `You are an English teacher helping an Arabic-speaking family learn. Expand this short dialogue with 2 more natural lines for each speaker (A and B). Keep the language simple and suitable for beginners. Provide the expanded dialogue in English and then its Arabic translation. Format it clearly like this:
English Dialogue:
[expanded dialogue here]

Arabic Translation:
[translation here]
Original Dialogue:\n"${state.selectedDay.english}"`;
            const result = await callGeminiAPI(prompt);
             const englishDialogueMatch = result.match(/English Dialogue:([\s\S]*?)Arabic Translation:/);
            const englishTextForTTS = englishDialogueMatch ? englishDialogueMatch[1].trim().replace(/\n/g, ' ') : '';

            const formattedResult = result
                .replace(/English Dialogue:/g, `<div class="flex items-center gap-3 justify-end"><button class="listen-sentence-btn text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${englishTextForTTS.replace(/"/g, '&quot;')}"><span>🔊</span></button><h4 class="font-bold text-teal-800 mb-2">الحوار الموسّع:</h4></div>`)
                .replace(/Arabic Translation:/g, '<h4 class="font-bold text-teal-800 mt-4 mb-2">الترجمة:</h4>')
                .replace(/\n/g, '<br>')
                .replace(/A:/g, '<strong>A:</strong>').replace(/B:/g, '<strong>B:</strong>')
                .replace(/أ:/g, '<strong>أ:</strong>').replace(/ب:/g, '<strong>ب:</strong>');
            geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2">${formattedResult}</div>`;
        }));

        newSituationBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `You are an English teacher creating practice scenarios for an Arabic-speaking family. Using these keywords: "${state.selectedDay.words}", create a completely new, short, simple dialogue (2-3 lines for each speaker: A and B). Provide the dialogue in English and then its Arabic translation. Format it clearly like this:
English Dialogue:
[dialogue here]

Arabic Translation:
[translation here]`;
            const result = await callGeminiAPI(prompt);
            const englishDialogueMatch = result.match(/English Dialogue:([\s\S]*?)Arabic Translation:/);
            const englishTextForTTS = englishDialogueMatch ? englishDialogueMatch[1].trim().replace(/\n/g, ' ') : '';

            const formattedResult = result
                .replace(/English Dialogue:/g, `<div class="flex items-center gap-3 justify-end"><button class="listen-sentence-btn text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${englishTextForTTS.replace(/"/g, '&quot;')}"><span>🔊</span></button><h4 class="font-bold text-teal-800 mb-2">حوار جديد مقترح:</h4></div>`)
                .replace(/Arabic Translation:/g, '<h4 class="font-bold text-teal-800 mt-4 mb-2">الترجمة:</h4>')
                .replace(/\n/g, '<br>')
                .replace(/A:/g, '<strong>A:</strong>').replace(/B:/g, '<strong>B:</strong>')
                .replace(/أ:/g, '<strong>أ:</strong>').replace(/ب:/g, '<strong>ب:</strong>');
            geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2">${formattedResult}</div>`;
        }));
        
        selectedLessonSection.addEventListener('click', (e) => {
            const listenButton = e.target.closest('.listen-sentence-btn');
            if (listenButton && !state.isTTSLoading && !state.isGeminiLoading) {
                const textToSpeak = listenButton.dataset.sentence;
                const originalIcon = listenButton.innerHTML;
                listenButton.innerHTML = `<span>⏳</span>`;
                listenButton.disabled = true;
                state.isTTSLoading = true;

                callGeminiTTSAPI(textToSpeak, () => {
                    listenButton.innerHTML = originalIcon;
                    listenButton.disabled = false;
                    state.isTTSLoading = false;
                });
            }
        });


        explainRuleBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `As an English teacher for an Arabic-speaking family, simply explain in Arabic the main grammar rule in this English sentence: "${state.selectedDay.english}". Focus on one key concept. Keep it very simple and use bullet points if helpful.`;
            const result = await callGeminiAPI(prompt);
            geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2 whitespace-pre-wrap">${result}</div>`;
        }));
        
        visualizeSituationBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `A cheerful, simple, and bright cartoon illustration for a family learning English. The scene should depict: "${state.selectedDay.situation}". Include elements related to these keywords: ${state.selectedDay.words}. The style should be friendly and educational for kids.`;
            const imageUrl = await callImagenAPI(prompt);
            if(imageUrl) {
                geminiResponseContainer.innerHTML = `<img src="${imageUrl}" alt="صورة تم توليدها بواسطة الذكاء الاصطناعي" class="rounded-lg shadow-md mx-auto max-w-full h-auto" />`;
            } else {
                geminiResponseContainer.innerHTML = `<p class="text-red-500">لم يتمكن الذكاء الاصطناعي من إنشاء صورة. حاول مرة أخرى.</p>`;
            }
        }));
        
        rolePlayBtn.addEventListener('click', () => {
            if (!state.selectedDay) return;
            const firstLine = state.selectedDay.english.split('B:')[0].trim();
            const secondLine = "B:" + state.selectedDay.english.split('B:')[1].trim();

            geminiResponseContainer.innerHTML = `
                <div class="text-right w-full space-y-3">
                    <h4 class="font-bold text-teal-800">لعب الأدوار 🎭</h4>
                     <div class="flex items-center gap-3 bg-stone-100 p-3 rounded-lg">
                        <button class="listen-sentence-btn text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${firstLine.replace(/"/g, '&quot;')}"><span>🔊</span></button>
                        <p class="text-stone-600 text-left dir-ltr">${firstLine}</p>
                    </div>
                    <p class="text-stone-700">الآن دورك. اكتب ردك في الأسفل كـ (B):</p>
                    <textarea id="role-play-input" class="w-full p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-rose-400"></textarea>
                    <button id="check-role-play-btn" class="gemini-btn bg-rose-500 text-white font-semibold py-2 px-5 rounded-full hover:bg-rose-600 transition">تحقق من ردي</button>
                    <div id="role-play-feedback" class="mt-2"></div>
                </div>
            `;

            document.getElementById('check-role-play-btn').addEventListener('click', () => {
                 const userInput = document.getElementById('role-play-input').value;
                 const feedbackContainer = document.getElementById('role-play-feedback');
                 if (!userInput) {
                     feedbackContainer.innerHTML = `<p class="text-amber-600">الرجاء كتابة رد أولاً.</p>`;
                     return;
                 }
                 
                 handleGeminiButtonClick(async () => {
                    feedbackContainer.innerHTML = '<div class="loader mx-auto"></div>';
                    const prompt = `You are a friendly English teacher. A student is practicing a dialogue. The correct line for Speaker B is: "${secondLine}". The student wrote: "${userInput}". Is the student's response correct or close enough? Provide a very simple correction and encouragement in Arabic. Keep the feedback short.`;
                    const result = await callGeminiAPI(prompt);
                    feedbackContainer.innerHTML = `<div class="p-2 text-rose-800 bg-rose-50 rounded-lg mt-2">${result}</div>`;
                 });
            });
        });

        quizBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `You are an English teacher creating a simple quiz for an Arabic-speaking family. Based on these keywords: "${state.selectedDay.words}", create ONE simple multiple-choice question to test one of the words. The question and options should be in English. Provide the correct answer separately. Format it as a valid JSON object only: {"question": "...", "options": ["...", "...", "..."], "answer": "..."}`;
            const result = await callGeminiAPI(prompt);
            
            try {
                // Find and extract the JSON part of the string to make parsing more robust
                const jsonMatch = result.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error("No valid JSON found in the API response.");
                }
                const jsonString = jsonMatch[0];
                const quizData = JSON.parse(jsonString);

                let optionsHTML = '';
                quizData.options.forEach(option => {
                    optionsHTML += `<button class="quiz-option-btn w-full bg-lime-100 text-lime-800 p-3 rounded-lg hover:bg-lime-200 transition" data-option="${option}">${option}</button>`;
                });

                geminiResponseContainer.innerHTML = `
                    <div class="text-right w-full space-y-3">
                         <div class="flex items-center gap-3 justify-end">
                            <button class="listen-sentence-btn text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${quizData.question.replace(/"/g, '&quot;')}"><span>🔊</span></button>
                            <h4 class="font-bold text-teal-800">اختبار سريع 🧠</h4>
                         </div>
                         <p class="text-stone-700 text-lg text-left dir-ltr">${quizData.question}</p>
                         <div class="space-y-2">${optionsHTML}</div>
                         <div id="quiz-feedback" class="mt-2 h-6"></div>
                    </div>
                `;

                document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const selectedOption = btn.dataset.option;
                        const feedbackContainer = document.getElementById('quiz-feedback');
                        document.querySelectorAll('.quiz-option-btn').forEach(b => b.disabled = true);
                        if(selectedOption.toLowerCase() === quizData.answer.toLowerCase()) {
                            btn.classList.remove('bg-lime-100');
                            btn.classList.add('bg-green-500', 'text-white');
                            feedbackContainer.innerHTML = `<p class="text-green-600 font-bold">إجابة صحيحة!</p>`;
                        } else {
                            btn.classList.remove('bg-lime-100');
                            btn.classList.add('bg-red-500', 'text-white');
                            feedbackContainer.innerHTML = `<p class="text-red-600 font-bold">حاول مرة أخرى. الإجابة الصحيحة هي: ${quizData.answer}</p>`;
                        }
                    });
                });

            } catch(e) {
                geminiResponseContainer.innerHTML = `<p class="text-red-500">حدث خطأ أثناء إنشاء الاختبار. حاول مرة أخرى.</p>`;
            }
        }));

        storyBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `You are an English teacher. Write a very short and simple story (2-3 sentences) for a beginner English learner, using these keywords: "${state.selectedDay.words}". Provide the story in English and then its Arabic translation. Format it clearly like this:
English Story:
[story here]

Arabic Translation:
[translation here]`;
            const result = await callGeminiAPI(prompt);
            const englishStoryMatch = result.match(/English Story:([\s\S]*?)Arabic Translation:/);
            const englishTextForTTS = englishStoryMatch ? englishStoryMatch[1].trim().replace(/\n/g, ' ') : '';

            const formattedResult = result
                .replace(/English Story:/g, `<div class="flex items-center gap-3 justify-end"><button class="listen-sentence-btn text-xl text-sky-600 hover:text-sky-800 transition" data-sentence="${englishTextForTTS.replace(/"/g, '&quot;')}"><span>🔊</span></button><h4 class="font-bold text-teal-800 mb-2">قصة اليوم:</h4></div>`)
                .replace(/Arabic Translation:/g, '<h4 class="font-bold text-teal-800 mt-4 mb-2">الترجمة:</h4>')
                .replace(/\n/g, '<br>');
            geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2">${formattedResult}</div>`;
        }));

        cultureBtn.addEventListener('click', () => handleGeminiButtonClick(async () => {
            const prompt = `Based on the daily situation of '${state.selectedDay.situation}', provide a very short, simple, and interesting cultural tip in Arabic for a family learning English. Keep it concise.`;
            const result = await callGeminiAPI(prompt);
            geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2"><h4 class="font-bold text-teal-800 mb-2">💡 معلومة ثقافية:</h4><p>${result}</p></div>`;
        }));

        correctSentenceBtn.addEventListener('click', () => {
            const sentence = sentenceInput.value.trim();
            if (!sentence) {
                geminiResponseContainer.innerHTML = `<p class="text-amber-600">الرجاء كتابة جملة أولاً.</p>`;
                return;
            }
            handleGeminiButtonClick(async () => {
                const prompt = `You are an English teacher for an Arabic-speaking family. Correct the following sentence written by a beginner. Provide the corrected sentence and a very simple, one-line explanation in Arabic about the correction.\n- Sentence to correct: "${sentence}"\n- The learner was trying to use these keywords: "${state.selectedDay.words}"\n- Format your response clearly in two parts: "الجملة الصحيحة:" and "الشرح:".`;
                const result = await callGeminiAPI(prompt);
                const formattedResult = result
                    .replace(/الجملة الصحيحة:/g, '<h4 class="font-bold text-teal-800 mb-2">الجملة الصحيحة:</h4>')
                    .replace(/الشرح:/g, '<h4 class="font-bold text-teal-800 mt-4 mb-2">الشرح:</h4>')
                    .replace(/\n/g, '<br>');
                geminiResponseContainer.innerHTML = `<div class="text-right text-lg p-2">${formattedResult}</div>`;
            });
        });

        function updateActiveMonthButton() {
            document.querySelectorAll('.month-btn').forEach(btn => {
                if (btn.dataset.month === state.selectedMonth) {
                    btn.classList.add('bg-teal-600', 'text-white');
                    btn.classList.remove('text-stone-600');
                } else {
                    btn.classList.remove('bg-teal-600', 'text-white');
                    btn.classList.add('text-stone-600');
                }
            });
        }
        
        function updateActiveDayCard() {
             document.querySelectorAll('.day-card').forEach(card => {
                if (card.dataset.day === state.selectedDay.day) {
                    card.classList.add('border-teal-400', 'ring-2', 'ring-teal-300');
                    card.classList.remove('border-stone-100');
                } else {
                    card.classList.remove('border-teal-400', 'ring-2', 'ring-teal-300');
                    card.classList.add('border-stone-100');
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const uniqueMonths = [...new Set(yearlyPlanData.map(item => item.month))];
            state.selectedMonth = uniqueMonths[0];
            
            renderMonthButtons(uniqueMonths);
            renderDailyCards(state.selectedMonth);
            updateActiveMonthButton();
        });

    </script>
</body>
</html>

